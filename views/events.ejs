<!-- Events Data Page -->
<!-- Dawson Broadbent, Ashlynn Burgess, Markus Walker -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Events - Ella Rises</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <!-- Global navigation/header -->
  <%- include('partials/header') %>

  <!-- Page title + subtitle -->
  <div class="page-header">
    <div class="container">
      <h1>Events</h1>
      <p style="opacity: 0.8;">Upcoming and past community events</p>
    </div>
  </div>

  <section class="content-section">
    <div class="container">
      <!-- Display server-side error messages -->
      <% if (error_message) { %>
      <div class="alert alert-error"><%= error_message %></div>
      <% } %>

      <!-- SEARCH BAR + ADD-EVENT BUTTON ROW -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px;">
        <!-- Search form (persists value using "q") -->
        <form action="/events" method="GET" class="search-box" style="margin-bottom: 0;">
          <input type="text" name="q" placeholder="Search events..." value="<%= q || '' %>">
          <button type="submit" class="btn btn-secondary">Search</button>
        </form>
        <!-- Add Event button (visible only to users with editing permissions) -->
        <% if (canEdit) { %>
        <button type="button" class="btn btn-primary" onclick="document.getElementById('addForm').style.display = document.getElementById('addForm').style.display === 'none' ? 'block' : 'none'">Add Event</button>
        <% } %>
      </div>

      <!-- ADD EVENT FORM (Admin/Editor-Only) -->
      <% if (canEdit) { %>
      <div id="addForm" class="card" style="display: none; margin-bottom: 30px;">
        <h3 style="margin-bottom: 20px;">Add New Event</h3>
        <form action="/events/add" method="POST">
          <!-- Event name from defined templates -->
          <div class="form-group">
            <label for="event_name">Event Name</label>
            <select id="event_name" name="event_name" required>
              <option value="">Select an event...</option>
              <% eventtemplates.forEach(function(template) { %>
                <option value="<%= template.eventname %>"><%= template.eventname %></option>
              <% }); %>
            </select>
          </div>
          <!-- Start + End datetime inputs -->
          <div class="form-row">
            <div class="form-group">
              <label for="eventdatetimestart">Start Date and Time</label>
              <input type="datetime-local" id="eventdatetimestart" name="eventdatetimestart" required>
            </div>
            <div class="form-group">
              <label for="eventdatetimeend">End Date and Time</label>
              <input type="datetime-local" id="eventdatetimeend" name="eventdatetimeend" required>
            </div>
          </div>
          <!-- Location dropdown populated from database -->
          <div class="form-group">
            <label for="eventlocation">Location</label>
            <select id="eventlocation" name="eventlocation">
              <option value="">Select a location...</option>
              <% locations.forEach(function(loc) { %>
                <option value="<%= loc.eventlocation %>"><%= loc.eventlocation %></option>
              <% }); %>
            </select>
          </div>
          <!-- Registration deadline -->
          <div class="form-group">
            <label for="eventregistrationdeadline">Registration Deadline</label>
            <input type="datetime-local" id="eventregistrationdeadline" name="eventregistrationdeadline" required>
          </div>
        
          <button type="submit" class="btn btn-primary">Add Event</button>
        </form>
        </div>
      <% } %>

      <!-- EVENTS TABLE (scrollable, sticky header) -->
      <div class="table-scroll" role="region" aria-label="Events table" tabindex="0">
        <table class="sticky-table">
          <thead>
            <tr>
              <th>Event Name</th>
              <th>Start Date and Time</th>
              <th>End Date and Time</th>
              <th>Location</th>
              <th>Registration Deadline</th>
              <% if (canEdit) { %><th>Actions</th><% } %>
            </tr>
          </thead>
          <tbody>
            <!-- No data found -->
            <% if (events.length === 0) { %>
            <tr>
              <td colspan="<%= canEdit ? 6 : 5 %>" style="text-align: center; color: #666;">No events found.</td>
            </tr>
            <% } else { %>

            <!-- Render each event row -->
            <% events.forEach(e => { %>
            <tr>
              <td><%= e.eventname %></td>

              <!-- Convert ISO timestamps to readable U.S. format -->
              <td><%= e.eventdatetimestart ? new Date(e.eventdatetimestart).toLocaleString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true
              }) : 'TBD' %></td>

              <td><%= e.eventdatetimeend ? new Date(e.eventdatetimeend).toLocaleString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true
              }) : 'TBD' %></td>

              <td><%= e.eventlocation || 'TBD' %></td>

              <td><%= e.eventregistrationdeadline ? new Date(e.eventregistrationdeadline).toLocaleString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true
              }) : 'TBD' %></td>

              <% if (canEdit) { %>
              <td class="action-buttons">

                <!-- EDIT BUTTON (passes event data via dataset attributes) -->
                <button
                  type="button"
                  class="btn-edit"
                  data-eventid="<%= e.eventid %>"
                  data-eventname="<%= e.eventname || '' %>"
                  data-start="<%= e.eventdatetimestart ? new Date(e.eventdatetimestart).toISOString() : '' %>"
                  data-end="<%= e.eventdatetimeend ? new Date(e.eventdatetimeend).toISOString() : '' %>"
                  data-location="<%= e.eventlocation || '' %>"
                  data-deadline="<%= e.eventregistrationdeadline ? new Date(e.eventregistrationdeadline).toISOString() : '' %>"
                  onclick="openEditModal(this)"
                >
                  Edit
                </button>

                <!-- DELETE BUTTON (confirmation prompt) -->
                <form action="/events/<%= e.eventid %>/delete" method="POST" style="display: inline;" onsubmit="return confirm('Delete this event?')">
                  <button type="submit" class="btn-delete">Delete</button>
                </form>

              </td>
              <% } %>
            </tr>
            <% }) %>

            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- EDIT MODAL (Admin/Editor only) -->
  <% if (canEdit) { %>
    <div id="editModalBackdrop" class="modal-backdrop" onclick="backdropClose(event)">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editModalTitle" onclick="event.stopPropagation()">
        <!-- Modal Header -->
        <div class="modal-header">
          <h3 id="editModalTitle">Edit Event</h3>
          <button class="modal-close" type="button" onclick="closeEditModal()" aria-label="Close">Ã—</button>
        </div>
        <!-- Modal Body -->
        <div class="modal-body">
          <form id="editEventForm" method="POST">
            <!-- Event Name -->
            <div class="form-group">
              <label for="edit_eventname">Event Name</label>
              <select id="edit_eventname" name="eventname" required>
                <option value="">Select an event...</option>
                <% eventtemplates.forEach(function(template) { %>
                  <option value="<%= template.eventname %>"><%= template.eventname %></option>
                <% }); %>
              </select>
            </div>
            <!-- Start + End -->
            <div class="form-row">
              <div class="form-group">
                <label for="edit_start">Start Date and Time</label>
                <input type="datetime-local" id="edit_start" name="eventdatetimestart" required>
              </div>
              <div class="form-group">
                <label for="edit_end">End Date and Time</label>
                <input type="datetime-local" id="edit_end" name="eventdatetimeend" required>
              </div>
            </div>
  
            <!-- Location + Deadline -->
            <div class="form-row">
              <div class="form-group">
                <label for="edit_location">Location</label>
                <select id="edit_location" name="eventlocation">
                  <option value="">Select a location...</option>
                  <% locations.forEach(function(loc) { %>
                    <option value="<%= loc.eventlocation %>"><%= loc.eventlocation %></option>
                  <% }); %>
                </select>
              </div>
              <div class="form-group">
                <label for="edit_deadline">Registration Deadline</label>
                <input type="datetime-local" id="edit_deadline" name="eventregistrationdeadline" required>
              </div>
            </div>
  
            <!-- Modal Footer Buttons -->
            <div class="modal-actions">
              <button type="button" class="btn-cancel" onclick="closeEditModal()">Cancel</button>
              <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  <% } %>
    
  <!-- Modal + Table Scripts -->
  <script>
    /**
     * Converts an ISO timestamp into yyyy-MM-ddTHH:mm
     * required by <input type="datetime-local">
     */
    function toDatetimeLocal(isoString) {
      if (!isoString) return '';
      const d = new Date(isoString);
      const pad = (n) => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    /**
     * Populate modal with the selected event's data
     * and show the modal.
     */
    function openEditModal(button) {
      const backdrop = document.getElementById('editModalBackdrop');
      const form = document.getElementById('editEventForm');
      if (!backdrop || !form) return;

      // Get data from button attributes
      const eventid = button.dataset.eventid;
      const eventname = button.dataset.eventname;
      const start = button.dataset.start;
      const end = button.dataset.end;
      const location = button.dataset.location;
      const deadline = button.dataset.deadline;

      form.action = `/events/${eventid}/edit`;

      // Load values from the row's dataset attributes
      document.getElementById('edit_eventname').value = eventname || '';
      document.getElementById('edit_start').value = toDatetimeLocal(start);
      document.getElementById('edit_end').value = toDatetimeLocal(end);
      document.getElementById('edit_location').value = location || '';
      document.getElementById('edit_deadline').value = toDatetimeLocal(deadline);

      backdrop.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    /* Hide modal */
    function closeEditModal() {
      const backdrop = document.getElementById('editModalBackdrop');
      if (!backdrop) return;
      backdrop.style.display = 'none';
      document.body.style.overflow = '';
    }

    /* Close modal only when clicking outside its content */
    function backdropClose(event) {
      // Only close if clicking the backdrop itself, not the modal content
      if (event.target.id === 'editModalBackdrop') {
        closeEditModal();
      }
    }

    // Allow closing with ESC key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeEditModal();
    });

    document.getElementById("editEventForm")?.addEventListener("submit", (e) => {
      const fd = new FormData(e.target);
    });
  </script>

  <!-- Global footer -->
  <%- include('partials/footer') %>
</body>
</html>